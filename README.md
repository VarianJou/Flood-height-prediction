# Flood Height Prediction Research Project

This repository contains code and data for analyzing flood height prediction using geospatial features including National Land Cover Database (NLCD) impervious surface data, digital elevation models (DEM), and machine learning routing algorithms. The project extracts landscape metrics around flood gauge locations and develops predictive models using multi-route neural network architectures.

## Project Overview

The project combines multiple data sources and analytical approaches:
1. **Feature Extraction**: Extracts landscape metrics from NLCD impervious surface layers and DEM data within 1.5km square buffers around flood gauge points
2. **Multi-temporal Analysis**: Matches flood events to their corresponding year's NLCD data (2016-2024)
3. **Machine Learning**: Implements routing-based neural network architectures for flood prediction modeling

## Repository Structure

### Folders
- **`data/`** - Contains processed feature datasets and analysis outputs
- **`routing/`** - Machine learning routing algorithms and training pipelines
- **`.idea/`** - IDE configuration files (IntelliJ/PyCharm)

## Code Files Overview

| File | Last Updated | Description |
|------|-------------|-------------|
| **NLCD_Extract_v0.1.0.py** | 2025-08-05 | Main script for extracting NLCD impervious surface features around flood points. Creates 1.5km square buffers, processes multi-year data (2016-2024), calculates landscape metrics including area percentages and core area indices. |
| **NLCD_Extract_v0.1.0_test.ipynb** | 2025-08-05 | Jupyter notebook for testing and prototyping the NLCD extraction workflow. Contains experimental code and visualizations for buffer creation and metrics calculation. |
| **dem_features.ipynb** | 2025-08-05 | Jupyter notebook for extracting digital elevation model (DEM) features around flood points. Processes topographic characteristics and terrain metrics. |
| **routing/routing.py** | 2025-08-05 | Core routing functionality for multi-route neural network architecture. Defines feature routing mappings and data preparation pipelines for ML models. |
| **routing/gs_routes.py** | 2025-08-05 | Grid search implementation for testing all possible feature-route combinations in the routing classifier. Generates and evaluates different routing strategies. |
| **routing/training.py** | 2025-08-05 | Training pipeline for routing-based neural network models. Includes model training, validation, and dummy data generation functions. |
| **CLAUDE.md** | 2025-08-05 | Project documentation and guidance for Claude Code AI assistant. Contains architecture overview, dependencies, and development notes. |
| **README.md** | 2025-08-05 | This file - comprehensive project documentation including file descriptions, usage instructions, and technical details. |

### Major Changes Summary
- **v0.1.0 (Initial)**: Multi-year NLCD processing, buffer creation, landscape metrics
- **Recent Updates**: Added DEM feature extraction, routing-based ML architecture, improved error handling and CRS transformations

## Input and Output Files

### Input Data Sources

#### External Input Files (Not in Repository)
| File | Size | Used By | Source | Description |
|------|------|---------|--------|-------------|
| **filtered_flooding_points_over_one_day_nopr.shp** | N/A | NLCD_Extract_v0.1.0.py | TBD | High water mark points with ID, peak_date, and geometry attributes |
| **Annual_NLCD_ImpDsc_[YEAR]_CU_C1V1.tif** | ~4GB each | NLCD_Extract_v0.1.0.py | USGS National Land Cover Database | Annual impervious surface data (2016-2024), 30m resolution |
| **DEM raster files** | Varies | dem_features.ipynb | TBD | Digital elevation model data for topographic features |

### Output Data Files (In Repository)

#### `data/` Directory
| File | Size | Generated By | Description |
|------|------|-------------|-------------|
| **imp_surface_features.csv** | 127 KB | NLCD_Extract_v0.1.0.py | NLCD-derived landscape metrics for each flood point including area percentages, core area indices, and impervious surface characteristics |
| **dem_features.csv** | 89 KB | dem_features.ipynb | DEM-derived topographic features including elevation, slope, aspect, and terrain roughness metrics |


### Feature Columns

#### imp_surface_features.csv
- `ID`: Flood point identifier
- `peak_date`: Original flood event date  
- `nlcd_year`: NLCD data year used for analysis
- `total_area_km2`: Total buffer area in km²
- `pct_area_1`: % of buffer with low-intensity impervious surface (20-49%)
- `pct_area_2`: % of buffer with medium-intensity impervious surface (50-79%)
- `area_km_1`, `area_km_2`: Absolute areas (km²) for each impervious class
- `cai_1`, `cai_2`: Core Area Index (landscape fragmentation metric)

## Technical Implementation

### NLCD Processing Workflow
1. **Load flood points** from shapefile and extract years from peak_date
2. **Create 1.5km square buffers** in projected coordinates (EPSG:5070) for accurate metric distances
3. **Match flood events** to corresponding year's NLCD data (2016-2024)
4. **Extract raster data** within buffers using spatial masking
5. **Recode NLCD values** (1→1, 2→2, others→0) and calculate landscape metrics
6. **Export structured results** to CSV files

### Machine Learning Architecture
- **Multi-route Neural Networks**: Routes different feature types (DEM, Imagery, Rainfall, Soil, Landuse, Vegetation, Impervious Surface) through specialized processing paths
- **Grid Search Optimization**: Tests all possible feature-route combinations to find optimal routing strategies
- **PyTorch Implementation**: Uses deep learning frameworks for model training and validation

### Key Technical Features
- **Memory Efficient**: Windowed reading loads only buffer-intersecting pixels
- **Multi-temporal Analysis**: Matches flood events to appropriate NLCD year
- **Accurate Geospatial Processing**: EPSG:5070 projection ensures proper metric calculations
- **Robust Error Handling**: Graceful handling of missing data and processing failures
- **Cross-platform Support**: Windows and Linux/Anvil cluster compatibility

## Dependencies

### Core Geospatial Libraries
- `rasterio` - Geospatial raster data I/O and processing
- `geopandas` - Vector geospatial data handling and operations
- `pylandstats` - Landscape ecology metrics calculation
- `shapely` - Geometric operations and spatial analysis

### Data Science & ML Libraries  
- `pandas` - Data manipulation and analysis
- `numpy` - Numerical computations
- `torch` - PyTorch deep learning framework
- `matplotlib` - Data visualization and plotting
- `tqdm` - Progress bar displays

## Usage Instructions

### NLCD Feature Extraction
```bash
python NLCD_Extract_v0.1.0.py
```

### DEM Feature Processing
```bash
jupyter notebook dem_features.ipynb
```

### ML Model Training
```bash
cd routing/
python gs_routes.py  # Grid search for optimal routing
python training.py   # Train routing classifier
```

## Notes

### Performance Considerations
- **Processing Time**: ~1200 flood points may require several hours for full NLCD analysis
- **Memory Usage**: NLCD files are ~4GB each but only buffer areas are loaded into memory
- **Parallel Processing**: Consider implementing multiprocessing for large datasets

### Data Quality Notes
- **Missing Years**: Script automatically uses closest available NLCD year when exact match unavailable
- **Coordinate Systems**: Automatic handling of CRS transformations between geographic and projected coordinates
- **Core Area Index**: Higher values indicate less fragmented landscapes (better habitat connectivity)

### Development Notes
- **File Paths**: Currently configured for Windows environment with alternative Linux paths commented out
- **Version Control**: Major processing steps are logged and versions tracked for reproducibility  
- **Error Logging**: Comprehensive error handling preserves processing continuity for large datasets
- **Modular Design**: Separate modules for routing, training, and feature extraction allow independent development and testing
